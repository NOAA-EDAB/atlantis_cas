---
title: "NE Groundfish fleet"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{NE Groundfish fleet}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



```{r setup, warning=FALSE, echo = F}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(atlantiscas)
library(ncdf4)
library(sf)
```


## Species

The [NE multispecies (Groundfish) FMP](https://www.nefmc.org/management-plans/northeast-multispecies) comprises the following species:

* Atlantic Cod (COD)
* Haddock (HAD)
* Yellowtail Flounder (YTF)
* Pollock (POL)
* American Plaice (PLA)
* Witch Flounder (WTF)
* White Hake (WHK)
* Winter Flounder (WIF)
* Redfish (RED)
* Atlantic Halibut (HAL)

Non target species

* Windowpane flounder (WPF)
* Ocean Pout (OPT)
* Atlantic Wolffish (WOL)

These GEARCAT(s) associated with groundfish species are:

* Bottom Trawl
* Sink Gillnet



** Still need to separate some species (sharks) **


```{r groundfishdata, echo = F}
# CONVERT TO METRIC TONS
lbstotons <- 2204.62
boundaryBoxes <- c(0,23:29)
gfData <- readRDS(here::here("data/NEGroundfishDataCAMS.rds")) 
gf <- gfData$neus |> 
  dplyr::mutate(Year = as.integer(Year)) |> 
  dplyr::mutate(InsideLANDED = InsideLANDED/lbstotons)

gfCodes <- c("COD","HAD","YTF","POL","PLA","WTF","WHK","WIF","RED","HAL","WPF","OPT","WOL")

gf |> dplyr::distinct(GEARCAT,GEARCODE) |> 
  dplyr::arrange(GEARCAT) |> 
  DT::datatable()

timeRange <- range(gf$Year)
```

## Landings

The landings of trips with associated bycatch

```{r plotland1, echo = F}
landings <- gf |> 
  dplyr::group_by(Year,Functional_Group,GEARCAT) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop")
                     
speciesLanded <- landings |> 
  dplyr::group_by(Functional_Group) |> 
  dplyr::summarise(nyrs = dplyr::n(),
                   .groups = "drop") |> 
  dplyr::filter(nyrs > 1) |> 
  dplyr::pull(Functional_Group)

landings |> 
  dplyr::filter(Functional_Group %in% speciesLanded) |> 
  ggplot2::ggplot() + 
  ggplot2::geom_line(ggplot2::aes(x=Year,y=landed,color=GEARCAT)) +
  ggplot2::facet_wrap(~Functional_Group) +
  ggplot2::ylab("Metric Tons") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) 

```

## Total groundfish landings for species in FMP

```{r plotcompare, echo = F}
landings <- gf |> 
  dplyr::filter(Code %in% gfCodes) |> 
  dplyr::mutate(facetLabel = paste0(Functional_Group," (",Code,")")) |> 
  dplyr::group_by(Year,facetLabel,GEARCAT) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop")

landings |> 
  ggplot2::ggplot() + 
  ggplot2::geom_line(ggplot2::aes(x=Year,y=landed,color=GEARCAT)) +
  ggplot2::facet_wrap(~facetLabel)+
  ggplot2::ylab("Metric Tons") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) 

```

## Total groundfish landings for bycatch species

```{r plotcompare2, echo = F}
landings <- gf |> 
  dplyr::filter(!(Code %in% gfCodes)) |>  
  dplyr::group_by(Year,Code,GEARCAT) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop")

landings |> 
  ggplot2::ggplot() + 
  ggplot2::geom_line(ggplot2::aes(x=Year,y=landed, color = GEARCAT)) +
  ggplot2::facet_wrap(~Code) 
  ggplot2::ylab("Metric Tons")  +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) 
  
```

## Landings of groundfish by species


```{r plotland2, echo =F}

gf |> 
  dplyr::group_by(Functional_Group,Code) |> 
  dplyr::summarise(mt = round(sum(InsideLANDED)),
                   .groups = "drop") |> 
  dplyr::arrange(desc(mt)) |> 
  DT::datatable(options = list(pageLength = 10,
                               order = list(list(0, 'asc'))
          ))
```


## Landings of Groundfish by state

```{r plotland3, echo = F}
landings <- gf |> 
  dplyr::filter(Code %in% gfCodes) |>  
  dplyr::group_by(Year,STATEABB,GEARCAT) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop")
                     
landings |> 
  ggplot2::ggplot() + 
  ggplot2::geom_line(ggplot2::aes(x=Year,y=landed,color=GEARCAT)) +
  ggplot2::facet_wrap(~STATEABB) +
  ggplot2::ylab("Metric Tons") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) 

```

## Landings of groundfish by port (species in FMP)

```{r plotland4, echo=F}
landings <- gf |> 
  dplyr::filter(Code %in% gfCodes) |>  
  dplyr::group_by(Year,STATEABB,newport,GEARCAT) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop")

ports10 <- landings |> 
  dplyr::group_by(newport,STATEABB) |> 
  dplyr::summarise(landed = sum(landed),
                   .groups = "drop") |> 
  dplyr::arrange(desc(landed)) |> 
  dplyr::slice(1:10) |> 
  dplyr::pull(newport)


landings |> 
  dplyr::filter(newport %in% ports10) |> 
  dplyr::group_by(Year,newport,GEARCAT) |> 
  dplyr::summarise(landed = sum(landed),
                   .groups="drop") |> 
  ggplot2::ggplot() + 
  ggplot2::geom_line(ggplot2::aes(x=Year,y=landed, color = GEARCAT)) +
  ggplot2::facet_wrap(~newport) +  
  ggplot2::ylab("Metric Tons") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) 

```


## Landings by Atlantis Box
compared to model output from v2.2.0

```{r plotland5, echo=F}
landings <- gf |> 
  dplyr::filter(Code %in% gfCodes) |>  
  dplyr::group_by(Year,Area) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop") |>
  tidyr::separate(col=Area,into = c("text","Box"),sep = "ID_") |> 
  dplyr::mutate(Box = as.numeric(Box)) |> 
  dplyr::select(-text) |> 
  dplyr::mutate(source = "CAMS") |> 
  dplyr::mutate(boundary = dplyr::case_when(!(Box %in% boundaryBoxes) ~ "NEUS domain",
                                            .default = "Boundary Box")) 



# Compare to atlantis

# 
# x.nc = nc_open(here::here("data-raw/atlantis",'neus_outputCATCH.nc'))
# varname = names(x.nc$var)
# vn <- grep('SCA_Catch_FC1',varname,value = T)
# 
# dd <- ncvar_get(x.nc,"SCA_Catch_FC1",collapse_degen = F)
# nc_close(x.nc)
# 
# rownames(dd) <- 1:nrow(dd)
# colnames(dd) <- 1:ncol(dd)
# 
# d2 <- as.data.frame(dd) |>
#   tibble::rownames_to_column(var="Box") |>
#   dplyr::mutate(Box = as.integer(Box) -1) |>
#   tidyr::pivot_longer(cols=-Box,names_to = "t",values_to = "value") |>
#   dplyr::mutate(t = as.integer(t),
#                 Year = 1963+ceiling(t/5)) |> 
#   dplyr::group_by(Box,Year) |> 
#   dplyr::summarise(mt = mean(value),
#                    .groups="drop") |> 
#   dplyr::relocate(Year,Box,mt) |> 
#   dplyr::mutate(source = "atlantis")
# 
# dataF <- rbind(d2,landings) |> 
#   dplyr::filter(Year > 1995)
# 

dataF <- landings
dataF |>
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x=Year,y=landed,color=source)) +
  ggplot2::facet_wrap(~Box) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) +
  ggplot2::ylab("Metric Tons") 

```

## Landings (data) by box spatially

Landings are displayed for the Boxes which cumulatively make up 95% of the landings.

```{r plotland6, echo =F}
dataBox <- dataF |> 
  dplyr::filter(source == "CAMS") |> 
  dplyr::group_by(Box) |> 
  dplyr::summarise(landed = sum(landed))

# select boxes which account fo 95% of landings
landings <- dataBox |> 
  dplyr::arrange(desc(landed)) |> 
  dplyr::mutate(cumsum = cumsum(landed), prop = cumsum/sum(landed)) |> 
  dplyr::filter(prop <= 0.95)

NEFSCspatial::Neus_atlantis |> 
  dplyr::left_join(landings,by = c("BOX_ID"="Box"))  |> 
  ggplot2::ggplot() +
  ggplot2::geom_sf(ggplot2::aes(fill = landed)) +
  ggplot2::geom_sf_text(ggplot2::aes(label = BOX_ID),
                        position = ggplot2::position_dodge(width=0.9),  size=3) 

```

Boxes that contribute 95% of landings `r landings |> dplyr::pull(Box) |> sort()`



## Ports Landings and revenue

Order the ports by NE groundfish landings and revenue.

### Landings
```{r ports1land, echo =F}
ports <- gf |> 
  dplyr::filter(Code %in% gfCodes) |> 
  dplyr::mutate(lat = round(lat,digits=2),
                lon = round(lon,digits = 2)) |> 
  dplyr::group_by(newport,STATEABB,PORTID,lat,lon) |> 
  dplyr::summarise(mt = round(sum(InsideLANDED)),
                   .groups = "drop")  |> 
  dplyr::arrange(desc(mt)) |> 
  dplyr::mutate(cummt = cumsum(mt),
                percent = round(cummt/sum(mt),digits=2)) |> 
   DT::datatable()
ports

```

### Revenue

Note there are `r gf |> dplyr::filter(is.na(InsideREV)) |> nrow()` records where revenue is NA.
Revenue has been deflated to xxxx using the GDP Implicit Price Deflator

```{r ports1rev, echo =F}
portsrev <- gf |> 
  dplyr::filter(Code %in% gfCodes) |> 
  dplyr::mutate(lat = round(lat,digits=2),
                lon = round(lon,digits = 2)) |> 
  dplyr::group_by(newport,STATEABB,PORTID,lat,lon) |> 
  dplyr::summarise(revenue = round(sum(InsideREV,na.rm = T)),
                   .groups = "drop")  |> 
  dplyr::arrange(desc(revenue)) |> 
  dplyr::mutate(cumrev = cumsum(revenue),
                percent = round(cumrev/sum(revenue),digits=2)) |>
  DT::datatable()
portsrev

```
## Select the main ports

The top ports ordered by landings or revenue are in relative agreement. The following ports are selected as the main ports to parameterize in the Atlantis model.

* MAINE
  * PORTLAND
* NEWHAMPSHIRE
  * PORTSMOUTH (SEABROOK)
* MASSACHUSETTS
  * GLOUCESTER
  * BOSTON (SCITUATE)
  * CHATHAM (PROVINCETOWN)
  * NEW BEDFORD
* RHODE ISLAND
  * POINT JUDITH
* CONNECTICUT
  * none
* NEW YORK
  * MONTAUK
  
** Note: MONTAUK, NY added for historic reason (although it was in the top 20 ports)**

```{r mainports, echo = F}
mainPortsIDs = c(240403,240207,220101,240115,420209,240301,320201,350635)
associatedPorts = data.frame(main=c(320201,240115,240301),associated=c(320901,240813,240601))
```


## Landings (data) by box spatially for main ports


Landings are displayed for the Boxes which cumulatively make up 95% of the landings.

```{r plotland7, echo =F}

# pick out 3 busiest ports based on landings
ports <- unique(c(mainPortsIDs,associatedPorts$associated))
portData <- gf |> 
  dplyr::filter(PORTID %in% ports) |> 
  dplyr::distinct(PORTID,newport,STATEABB,lat,lon) |> 
  dplyr::arrange(desc(lat))


landings <- gf |> 
  dplyr::filter(Code %in% gfCodes,
                PORTID %in% portData$PORTID) |>  
  dplyr::group_by(Year,Area,PORTID) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop") |>
  tidyr::separate(col=Area,into = c("text","Box"),sep = "ID_") |> 
  dplyr::mutate(Box = as.numeric(Box)) |> 
  dplyr::select(-text)

maxBoxLandings <- landings |> 
  dplyr::group_by(PORTID,Box) |> 
  dplyr::summarise(tots = sum(landed),
                   .groups = "drop") |> 
  dplyr::pull(tots) |> 
  max()

# create map for each
for (iport in portData$PORTID) {
  
  portName <- portData |> 
    dplyr::filter(PORTID == iport) |> 
    dplyr::pull(newport)
  
  # portlatlon <- ports |> 
  #   dplyr::filter(PORTID == iport)
  
  dataBox <- landings |> 
    dplyr::filter(PORTID == iport) |> 
    dplyr::group_by(Box) |> 
    dplyr::summarise(landed = sum(landed),
                     .groups="drop")
  
  # create landings by box (summed over time)
  boxLandings <- dataBox |>
    dplyr::arrange(desc(landed)) |>
    dplyr::mutate(cumsum = cumsum(landed), prop = cumsum/sum(landed)) |>
    dplyr::filter(prop <= 0.95)
  
  

  # select boxes which account fo 95% of landings
  p <- NEFSCspatial::Neus_atlantis |>
    dplyr::left_join(boxLandings,by = c("BOX_ID"="Box"))  |>
    ggplot2::ggplot() +
    ggplot2::geom_sf(ggplot2::aes(fill = landed)) +
    ggplot2::scale_fill_continuous(limits=c(0, maxBoxLandings))+
    ggplot2::geom_sf_text(ggplot2::aes(label = BOX_ID),
                          size=3) +
    ggplot2::geom_point(data = portData,
                        mapping=ggplot2::aes(x=lon,y=lat),
                        color="green") +
    ggplot2::geom_point(data = portData |> dplyr::filter(PORTID == iport),
                        mapping=ggplot2::aes(x=lon,y=lat),
                        color="red") +

    ggplot2::geom_text(data = portData,
                       ggplot2::aes(x=lon,y=lat,label = newport),
                       size = 2.5,
                       hjust=1, vjust=0) + 
    ggplot2::ggtitle(portName) +
    ggplot2::coord_sf(xlim = c(-80,-62)) 
  
  suppressWarnings(print(p))
}


```


## Aggregate remaining data as "other" fleet

The remaining ports (other than the ports listed above) make up ~10% of total landings. All trips associated with these ports will be combined to form one fleet which will fish in the footprint below. This maintains the communities at sea idea for the main ports but takes into account all remaining landings to satisfy model requirements

```{r otherfleet,echo = F}
ports <- unique(c(mainPortsIDs,associatedPorts$associated))

otherFleet <- gf |> 
  dplyr::filter(!(PORTID %in% ports),
                Code %in% gfCodes) |> 
  dplyr::group_by(Year,Area) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop") |>
  tidyr::separate(col=Area,into = c("text","Box"),sep = "ID_") |> 
  dplyr::mutate(Box = as.numeric(Box)) |> 
  dplyr::select(-text)

otherFleetLandings <- sum(otherFleet$landed)
timerange <- range(otherFleet$Year)

otherFleetBox <- otherFleet |> 
  dplyr::group_by(Box) |> 
  dplyr::summarise(landed = sum(landed),
                   .groups = "drop") 

  
  # select boxes which account fo 95% of landings
  p <- NEFSCspatial::Neus_atlantis |>
    dplyr::left_join(otherFleetBox,by = c("BOX_ID"="Box"))  |>
    ggplot2::ggplot() +
    ggplot2::geom_sf(ggplot2::aes(fill = landed)) +
    #ggplot2::scale_fill_continuous(limits=c(0, maxBoxLandings))+
    ggplot2::geom_sf_text(ggplot2::aes(label = BOX_ID),
                          size=3) +
    ggplot2::ggtitle("Other Fleet") +
    ggplot2::coord_sf(xlim = c(-80,-62)) 
  
  suppressWarnings(print(p))

```

Total Landings over `r paste(timerange,collapse="-")` = `r round(otherFleetLandings)` metric tons

Time series of landings by box of other fleet


```{r otherfleettime, echo = F}

otherFleetBoundary <- 
  otherFleet |> 
  dplyr::mutate(boundary = dplyr::case_when(!(Box %in% boundaryBoxes) ~ "NEUS domain",
                                            .default = "Boundary Box")) 
  
otherFleetBoundary |> 
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x=Year,y=landed,color = factor(boundary)))+
  ggplot2::facet_wrap(~Box) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) +
  ggplot2::ylab("Metric Tons") +
  ggplot2::labs(color=" ")
```

## Effort

```{r effort1, echo =F}


effort <- gf |> 
  dplyr::filter(Code %in% gfCodes) |> 
  dplyr::group_by(Year,newport) |>
  dplyr::summarise(effort = sum(InsideDAS),
                   landed = sum(InsideLANDED),
                   .groups = "drop") |> 
  dplyr::filter(newport %in% ports10)
# |> 
#   tidyr::pivot_longer(-c(Year,PORTLANDED),names_to = "type",values_to = "value")

ggplot2::ggplot(effort) +
  ggplot2::geom_line(ggplot2::aes(x=Year,y=effort)) +
  ggplot2::facet_wrap(~as.factor(newport)) + 
  ggplot2::ylab("Effort (Days)") +
  ggplot2::ggtitle("Effort by port for top 10 productive ports") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) 

```





