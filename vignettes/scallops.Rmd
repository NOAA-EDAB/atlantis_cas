---
title: "scallops"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{scallops}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



```{r setup, warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(atlantiscas)
library(ncdf4)
library(sf)
```

## Atlantis parameterization
(Codebase v6681)

1. Forced effort time series (days $day^{-1}$) - effortmodel = 11 (Running into segmentation error issues)

2. YYY_effort > 0 (Fixed total effort, days $day^{-1}$)


## Trial for Atlantis conversion

First look at the data to see how many gear types, and which ports landed the scallops.

The fishing data were processed and passed through minimal QA/QC. All ports were assigned lat and lons (as best as possible), all landings were assigned to an atlantis group.

SCA is the atlantis group for scallops.

Gear Categories identified, in the data set, as scallop vessels were

* TRAWL BOTTOM SCALLOP
* DREDGE SCALLOP
* Scallop Gear 

These GEARCAT(s) were filtered to provide the following output

```{r scallopData, echo = F}
lbstotons <- 2204.62
scallopData <- readRDS(here::here("data/scallopDataCAMS.rds"))

sca <- scallopData$neus |> 
  dplyr::mutate(Year = as.integer(Year),
                InsideLANDED = InsideLANDED/lbstotons)

sca |> dplyr::distinct(GEARCAT,GEARCODE) |> 
  dplyr::arrange(GEARCAT) |> 
  DT::datatable()
```

## Landings

The landings of Scallop trips with associated bycatch

```{r plotland1, echo = F}
landings <- sca |> 
  dplyr::group_by(Year,Functional_Group) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop")
                     
speciesLanded <- landings |> 
  dplyr::group_by(Functional_Group) |> 
  dplyr::summarise(nyrs = dplyr::n(),
                   .groups = "drop") |> 
  dplyr::filter(nyrs > 1) |> 
  dplyr::pull(Functional_Group)

landings |> 
  dplyr::filter(Functional_Group %in% speciesLanded) |> 
  ggplot2::ggplot() + 
  ggplot2::geom_line(ggplot2::aes(x=Year,y=landed)) +
  ggplot2::facet_wrap(~Functional_Group) +
  ggplot2::ylab("Metric Tons") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) 

```

## Total scallop landings compared to bycatch

```{r plotcompare, echo = F}
landings <- sca |> 
  dplyr::filter(Code == "SCA") |>  
  dplyr::group_by(Year,STATEABB) |> 
  dplyr::summarise(landed = round(sum(InsideLANDED),digits=2),
                   .groups = "drop")

```

```{r plotland2, echo =F}

sca |> 
  dplyr::group_by(Functional_Group) |> 
  dplyr::summarise(landed = round(sum(InsideLANDED),digits=2),
                   .groups = "drop") |> 
  dplyr::arrange(desc(landed)) |> 
  DT::datatable(options = list(pageLength = 10,
                               order = list(list(0, 'asc'))
          ))
```


## Landings of Scallops by state

```{r plotland3, echo = F}
landings <- sca |> 
  dplyr::filter(Code == "SCA") |>  
  dplyr::group_by(Year,STATEABB) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop")
                     
landings |> 
  ggplot2::ggplot() + 
  ggplot2::geom_line(ggplot2::aes(x=Year,y=landed)) +
  ggplot2::facet_wrap(~STATEABB) +
  ggplot2::ylab("Metric Tons") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90))  

```

## Landings of Scallops by port

```{r plotland4, echo=F}
landings <- sca |> 
  dplyr::filter(Code == "SCA") |>  
  dplyr::group_by(Year,STATEABB,newport) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop")

ports10 <- landings |> 
  dplyr::group_by(newport,STATEABB) |> 
  dplyr::summarise(landed = sum(landed),
                   .groups = "drop") |> 
  dplyr::arrange(desc(landed)) |> 
  dplyr::slice(1:10) |> 
  dplyr::pull(newport)


landings |> 
  dplyr::filter(newport %in% ports10) |> 
  dplyr::group_by(Year,newport) |> 
  dplyr::summarise(landed = sum(landed),
                   .groups="drop") |> 
  ggplot2::ggplot() + 
  ggplot2::geom_line(ggplot2::aes(x=Year,y=landed)) +
  ggplot2::facet_wrap(~newport) +
  ggplot2::ylab("Metric Tons") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) 

```


## Landings by Atlantis Box
compared to model output from v2.2.0

```{r plotland5, echo=F}
landings <- sca |> 
  dplyr::filter(Code == "SCA") |>  
  dplyr::group_by(Year,Area) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop") |>
  tidyr::separate(col=Area,into = c("text","Box"),sep = "ID_") |> 
  dplyr::mutate(Box = as.numeric(Box)) |> 
  dplyr::select(-text) |> 
  dplyr::mutate(source = "CAMS")

# Atlantis v2.2.0 scallop catch by box

x.nc = nc_open(here::here("data-raw/atlantis",'neus_outputCATCH.nc'))
varname = names(x.nc$var)
vn <- grep('SCA_Catch_FC1',varname,value = T)

dd <- ncvar_get(x.nc,"SCA_Catch_FC1",collapse_degen = F)
nc_close(x.nc)

rownames(dd) <- 1:nrow(dd)
colnames(dd) <- 1:ncol(dd)

d2 <- as.data.frame(dd) |>
  tibble::rownames_to_column(var="Box") |>
  dplyr::mutate(Box = as.integer(Box) -1) |>
  tidyr::pivot_longer(cols=-Box,names_to = "t",values_to = "value") |>
  dplyr::mutate(t = as.integer(t),
                Year = 1963+ceiling(t/5)) |> 
  dplyr::group_by(Box,Year) |> 
  dplyr::summarise(landed = mean(value),
                   .groups="drop") |> 
  dplyr::relocate(Year,Box,landed) |> 
  dplyr::mutate(source = "atlantis")

dataF <- rbind(d2,landings) |> 
  dplyr::filter(Year > 1995)
# 
# landings |> 
#   ggplot2::ggplot() + 
#   ggplot2::geom_line(ggplot2::aes(x=Year,y=mt)) +
#   ggplot2::facet_wrap(~Box) +
#   ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90))

dataF |> 
  ggplot2::ggplot() + 
  ggplot2::geom_line(ggplot2::aes(x=Year,y=landed,color=source)) +
  ggplot2::facet_wrap(~Box) +
  ggplot2::ylab("Metric Tons") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) 

```

## Landings (data) by box spatially

```{r plotland6, echo =F}
dataBox <- dataF |> 
  dplyr::filter(source == "CAMS") |> 
  dplyr::group_by(Box) |> 
  dplyr::summarise(landed = sum(landed))

# select boxes which account fo 95% of landings
landings <- dataBox |> 
  dplyr::arrange(desc(landed)) |> 
  dplyr::mutate(cumsum = cumsum(landed), prop = cumsum/sum(landed)) |> 
  dplyr::filter(prop <= 0.95)

NEFSCspatial::Neus_atlantis |> 
  dplyr::left_join(landings,by = c("BOX_ID"="Box"))  |> 
  ggplot2::ggplot() +
  ggplot2::geom_sf(ggplot2::aes(fill = landed)) +
  ggplot2::geom_sf_text(ggplot2::aes(label = BOX_ID),
                        position = ggplot2::position_dodge(width=0.9),  size=3)  +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) 

```

Boxes that contribute 95% of landings `r landings |> dplyr::pull(Box) |> sort()`


## Landings (data) by box spatially for 3 main ports

```{r plotland7, echo =F}

# pick out 3 busiest ports based on landings
ports <- sca |> 
  dplyr::group_by(newport,PORTID,lat,lon) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop") |> 
  dplyr::arrange(desc(landed)) |> 
  dplyr::slice(1:3) 

portids <- ports |> dplyr::pull(PORTID)

landings <- sca |> 
  dplyr::filter(Code == "SCA",PORTID %in% portids) |>  
  dplyr::group_by(Year,Area,PORTID) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop") |>
  tidyr::separate(col=Area,into = c("text","Box"),sep = "ID_") |> 
  dplyr::mutate(Box = as.numeric(Box)) |> 
  dplyr::select(-text)


maxBoxLandings <- landings |> 
  dplyr::group_by(PORTID,Box) |> 
  dplyr::summarise(tots = sum(landed),
                   .groups = "drop") |> 
  dplyr::pull(tots) |> 
  max()

# create map for each
for (iport in portids) {
  
  portName <- ports |> 
    dplyr::filter(PORTID == iport) |> 
    dplyr::pull(newport)
  
  # portlatlon <- ports |> 
  #   dplyr::filter(PORTID == iport)
  
  dataBox <- landings |> 
    dplyr::filter(PORTID == iport) |> 
    dplyr::group_by(Box) |> 
    dplyr::summarise(landed = sum(landed),
                     .groups="drop")
  
  # create landings by box (summed over time)
  boxLandings <- dataBox |>
  dplyr::arrange(desc(landed)) |>
  dplyr::mutate(cumsum = cumsum(landed), prop = cumsum/sum(landed)) |>
  dplyr::filter(prop <= 0.95)

  # select boxes which account fo 95% of landings
  p <- NEFSCspatial::Neus_atlantis |>
    dplyr::left_join(boxLandings,by = c("BOX_ID"="Box"))  |>
    ggplot2::ggplot() +
    ggplot2::geom_sf(ggplot2::aes(fill = landed)) +
    ggplot2::scale_fill_continuous(limits=c(0, maxBoxLandings))+
    ggplot2::geom_sf_text(ggplot2::aes(label = BOX_ID),
                          size=3) +
    ggplot2::geom_point(data = ports,
                        mapping=ggplot2::aes(x=lon,y=lat),
                        color="green") +
    ggplot2::geom_point(data = ports |> dplyr::filter(PORTID == iport),
                        mapping=ggplot2::aes(x=lon,y=lat),
                        color="red") +
    ggplot2::geom_text(data = ports,
                       ggplot2::aes(x=lon,y=lat,label = newport),
                       size = 2.5,
                       hjust=1, vjust=0) + 
    ggplot2::ggtitle(portName) +
    ggplot2::coord_sf(xlim = c(-80,-62)) 
  
  suppressWarnings(print(p))
}


```

## Location of ports

Location of ports that land scallops

```{r ports1, echo =F}
ports <- sca |> 
  dplyr::group_by(newport,PORTID,lat,lon) |> 
  dplyr::summarise(landed = sum(InsideLANDED),
                   .groups = "drop") |> 
  dplyr::arrange(desc(landed)) 


```



## Effort

```{r effort1, echo =F}


effort <- sca |> 
  dplyr::group_by(Year,newport) |>
  dplyr::summarise(effort = sum(InsideDAS),
                   landed = sum(InsideLANDED),
                   .groups = "drop") |> 
  dplyr::filter(newport %in% ports10)
# |> 
#   tidyr::pivot_longer(-c(Year,PORTLANDED),names_to = "type",values_to = "value")

ggplot2::ggplot(effort) +
  ggplot2::geom_line(ggplot2::aes(x=Year,y=effort)) +
  ggplot2::facet_wrap(~as.factor(newport)) + 
  ggplot2::ylab("Effort (Days)") +
  ggplot2::ggtitle("Effort by port for top 10 productive ports") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90)) 

```





